<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Tester (Swagger-like)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .method-get {
            @apply bg-blue-100 text-blue-800 border-blue-200;
        }

        .method-post {
            @apply bg-green-100 text-green-800 border-green-200;
        }

        .method-delete {
            @apply bg-red-100 text-red-800 border-red-200;
        }

        pre {
            @apply bg-slate-900 text-slate-50 p-4 rounded-lg overflow-x-auto text-sm font-mono;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen p-8 font-sans">

    <div class="max-w-5xl mx-auto">
        <header class="mb-10 text-center">
            <h1 class="text-3xl font-bold text-slate-800">API Documentation & Tester</h1>
            <p class="text-slate-500 mt-2">Test endpoints directly against <code
                    class="bg-slate-200 px-1 rounded">/kuscc-eval/api/proxy</code> (or direct PHP)</p>

            <div class="mt-6 flex justify-center gap-4">
                <div class="flex items-center gap-2">
                    <label class="font-medium">Base URL:</label>
                    <input type="text" id="baseUrl" value="https://apps4.coop.ku.ac.th/kuscc-eval/api/proxy"
                        class="border rounded px-3 py-1 w-96 text-sm">
                </div>
            </div>
        </header>

        <div id="endpoints" class="space-y-6"></div>
    </div>

    <!-- Template for an endpoint -->
    <template id="endpoint-template">
        <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden endpoint-card">
            <div
                class="p-4 cursor-pointer flex items-center justify-between hover:bg-slate-50 transition-colors header-section">
                <div class="flex items-center gap-4">
                    <span
                        class="method-badge px-3 py-1 rounded-md text-sm font-bold border uppercase w-20 text-center">GET</span>
                    <span class="font-mono text-slate-700 font-medium path">/api.php?action=...</span>
                    <span class="text-sm text-slate-500 desc">Description here</span>
                </div>
                <svg class="w-5 h-5 text-slate-400 transform transition-transform chevron" fill="none"
                    stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </div>

            <div class="border-t border-slate-100 p-6 hidden body-section bg-slate-50/50">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-bold text-sm text-slate-700 mb-3 uppercase tracking-wider">Parameters</h4>
                        <div class="params-container space-y-3">
                            <!-- Params injected here -->
                        </div>
                        <button
                            class="mt-4 px-4 py-2 bg-slate-800 text-white rounded hover:bg-slate-700 text-sm font-medium transition-colors execute-btn">
                            Execute
                        </button>
                    </div>

                    <div>
                        <h4 class="font-bold text-sm text-slate-700 mb-3 uppercase tracking-wider">Response</h4>
                        <div class="relative">
                            <pre
                                class="response-display min-h-[100px] max-h-[300px]">Click Execute to see response...</pre>
                            <div class="absolute top-2 right-2 text-xs text-slate-400 status-code"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
        const CONFIG = {
            endpoints: [
                {
                    method: 'GET',
                    action: 'get_init_data',
                    desc: 'Fetch all initial data (Users, Config, etc.)',
                    params: [
                        { name: 'evaluator_id', type: 'text', placeholder: 'Optional: Filter by evaluator ID (e.g. U_001)' },
                        { name: 'raw', type: 'boolean', placeholder: 'true', default: 'false', desc: 'Get raw scores structure' }
                    ]
                },
                {
                    method: 'POST',
                    action: 'update_score',
                    desc: 'Submit a score for a criterion',
                    params: [
                        { name: 'evaluatorId', type: 'text', placeholder: 'Internal ID (e.g. U_001)' },
                        { name: 'targetId', type: 'text', placeholder: 'Target ID (e.g. U_002)' },
                        { name: 'criteriaId', type: 'text', placeholder: 'Criteria ID (e.g. 1.1)' },
                        { name: 'score', type: 'number', placeholder: '1-4' }
                    ]
                },
                {
                    method: 'POST',
                    action: 'update_comment',
                    desc: 'Submit a comment for a user',
                    params: [
                        { name: 'evaluatorId', type: 'text', placeholder: 'Internal ID' },
                        { name: 'targetId', type: 'text', placeholder: 'Target ID' },
                        { name: 'comment', type: 'text', placeholder: 'Comment text' }
                    ]
                },
                {
                    method: 'GET',
                    action: 'reset_data',
                    desc: 'Reset all scores and comments (Danger)',
                    params: []
                },
                {
                    method: 'POST',
                    action: 'save_user',
                    desc: 'Create or Update a User',
                    params: [
                        { name: 'internalId', type: 'text', placeholder: 'New or Existing ID' },
                        { name: 'name', type: 'text', placeholder: 'Full Name' },
                        { name: 'role', type: 'text', placeholder: 'STAFF, MANAGER, etc.' },
                        { name: 'dept', type: 'text', placeholder: 'Department' },
                        { name: 'orgId', type: 'number', placeholder: 'Organization ID' }
                    ]
                },
                {
                    method: 'POST',
                    action: 'delete_user',
                    desc: 'Delete a User',
                    params: [
                        { name: 'internalId', type: 'text', placeholder: 'Internal ID to delete' }
                    ]
                },
                {
                    method: 'POST',
                    action: 'save_criteria',
                    desc: 'Create or Update Criteria',
                    params: [
                        { name: 'id', type: 'text', placeholder: 'ID (e.g. 1.1)' },
                        { name: 'text', type: 'text', placeholder: 'Criteria Name' },
                        { name: 'weight', type: 'number', placeholder: 'Weight (e.g. 20)' },
                        { name: 'category', type: 'text', placeholder: 'PERF, CHAR, EXEC' }
                    ]
                },
                {
                    method: 'POST',
                    action: 'add_exclusion',
                    desc: 'Add Evaluation Exclusion',
                    params: [
                        { name: 'evaluatorId', type: 'number', placeholder: 'Org ID of Evaluator' },
                        { name: 'targetId', type: 'number', placeholder: 'Org ID of Target' },
                        { name: 'reason', type: 'text', placeholder: 'Reason' }
                    ]
                }
            ]
        };

        const container = document.getElementById('endpoints');
        const template = document.getElementById('endpoint-template');
        const baseUrlInput = document.getElementById('baseUrl');

        // Render UI
        CONFIG.endpoints.forEach(ep => {
            const clone = template.content.cloneNode(true);
            const card = clone.querySelector('.endpoint-card');

            // Header
            card.querySelector('.method-badge').textContent = ep.method;
            card.querySelector('.method-badge').classList.add(`method-${ep.method.toLowerCase()}`);
            card.querySelector('.path').textContent = `?action=${ep.action}`;
            card.querySelector('.desc').textContent = ep.desc;

            // Toggle logic
            const header = card.querySelector('.header-section');
            const body = card.querySelector('.body-section');
            const chevron = card.querySelector('.chevron');

            header.addEventListener('click', () => {
                const isHidden = body.classList.contains('hidden');
                body.classList.toggle('hidden');
                chevron.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0)';
            });

            // Params
            const paramsContainer = card.querySelector('.params-container');
            if (ep.params.length === 0) {
                paramsContainer.innerHTML = '<span class="text-slate-400 italic text-sm">No parameters required</span>';
            } else {
                ep.params.forEach(p => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'flex flex-col gap-1';

                    const label = document.createElement('label');
                    label.className = 'text-xs font-semibold text-slate-600';
                    label.textContent = p.name + (p.type === 'boolean' ? ' (Check if true)' : '');

                    let input;
                    if (p.type === 'boolean') {
                        input = document.createElement('input');
                        input.type = 'checkbox';
                        input.className = 'ml-2';
                    } else {
                        input = document.createElement('input');
                        input.type = p.type === 'number' ? 'number' : 'text';
                        input.className = 'border border-slate-300 rounded px-2 py-1.5 text-sm w-full focus:ring-2 focus:ring-blue-100 outline-none transition';
                        input.placeholder = p.placeholder || '';
                    }
                    input.dataset.paramName = p.name;
                    input.dataset.type = p.type;

                    wrapper.appendChild(label);
                    if (p.type === 'boolean') label.appendChild(input);
                    else wrapper.appendChild(input);

                    paramsContainer.appendChild(wrapper);
                });
            }

            // Execute Logic
            const btn = card.querySelector('.execute-btn');
            const output = card.querySelector('.response-display');
            const statusDisplay = card.querySelector('.status-code');

            btn.addEventListener('click', async () => {
                btn.textContent = 'Running...';
                btn.disabled = true;
                output.textContent = 'Loading...';

                const inputs = paramsContainer.querySelectorAll('input');
                const payload = {};
                let queryString = `?action=${ep.action}`;

                inputs.forEach(inp => {
                    const name = inp.dataset.paramName;
                    if (!name) return;

                    let val;
                    if (inp.dataset.type === 'boolean') val = inp.checked;
                    else if (inp.dataset.type === 'number') val = Number(inp.value);
                    else val = inp.value;

                    // If GET, add to query string. If POST, add to body
                    if (ep.method === 'GET') {
                        if (val) queryString += `&${name}=${encodeURIComponent(val)}`;
                    } else {
                        payload[name] = val;
                    }
                });

                const url = baseUrlInput.value.replace(/\/$/, '') + queryString;

                try {
                    const opts = {
                        method: ep.method,
                        headers: { 'Content-Type': 'application/json' }
                    };
                    if (ep.method !== 'GET') {
                        opts.body = JSON.stringify(payload);
                    }

                    const start = Date.now();
                    const res = await fetch(url, opts);
                    const diff = Date.now() - start;

                    const statusText = `${res.status} ${res.statusText} (${diff}ms)`;
                    statusDisplay.textContent = statusText;
                    statusDisplay.className = res.ok ? 'absolute top-2 right-2 text-xs font-bold text-green-600' : 'absolute top-2 right-2 text-xs font-bold text-red-600';

                    let data;
                    const text = await res.text();
                    try { data = JSON.parse(text); } catch { data = text; }

                    output.textContent = JSON.stringify(data, null, 2);

                } catch (err) {
                    output.textContent = 'Error: ' + err.message;
                    statusDisplay.textContent = 'Network Error';
                } finally {
                    btn.textContent = 'Execute';
                    btn.disabled = false;
                }
            });

            container.appendChild(clone);
        });

        // Initialize URL based on current location if applicable
        if (window.location.hostname === 'localhost') {
            baseUrlInput.value = 'http://localhost:3000/kuscc-eval/api/proxy';
        } else if (window.location.href.includes('apps4')) {
            baseUrlInput.value = window.location.origin + '/kuscc-eval/api/proxy';
        }
    </script>
</body>

</html>